---
title: 构建工具与开发流程
description: 对比 Python 和 JavaScript 构建系统，掌握 webpack vs setuptools 差异，学习 Babel 转译，理解现代 JavaScript 开发工作流程
---

# 模块 11：构建工具与开发流程

## 学习目标

完成本模块后，你将能够：
- 对比 Python 和 JavaScript 构建系统
- 理解 webpack vs setuptools 的差异
- 掌握 Babel 转译和现代 JavaScript 特性
- 设置开发服务器和热重载
- 配置生产构建和优化
- 为 JavaScript 项目实施 CI/CD 流水线

## 构建系统对比

### Python：setuptools 和 pip

在 Python 中，你熟悉的方式：

<PythonEditor title="Python 构建系统" compare={true}>
```python !! py
# setup.py
from setuptools import setup, find_packages

setup(
    name="my-python-package",
    version="1.0.0",
    description="我的出色 Python 包",
    author="你的名字",
    author_email="your.email@example.com",
    packages=find_packages(),
    install_requires=[
        "requests>=2.28.0",
        "click>=8.0.0",
        "pydantic>=1.10.0"
    ],
    extras_require={
        "dev": [
            "pytest>=7.0.0",
            "black>=22.0.0",
            "flake8>=5.0.0"
        ]
    },
    entry_points={
        "console_scripts": [
            "my-cli=my_package.cli:main",
        ],
    },
    python_requires=">=3.8",
    classifiers=[
        "Development Status :: 4 - Beta",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: MIT License",
        "Programming Language :: Python :: 3.8+",
    ],
)

# pyproject.toml（现代方法）
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "my-python-package"
version = "1.0.0"
description = "我的出色 Python 包"
dependencies = [
    "requests>=2.28.0",
    "click>=8.0.0"
]

[project.optional-dependencies]
dev = ["pytest>=7.0.0", "black>=22.0.0"]

# 构建和分发
# python -m build
# pip install -e .  # 开发安装
# twine upload dist/*
```

```javascript !! js
// JavaScript 使用 webpack 的构建系统
// package.json
{
  "name": "my-js-package",
  "version": "1.0.0",
  "description": "我的出色 JavaScript 包",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "webpack --mode=production",
    "dev": "webpack serve --mode=development",
    "start": "node dist/index.js",
    "test": "jest",
    "lint": "eslint src/",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "axios": "^1.1.0",
    "lodash": "^4.17.21"
  },
  "devDependencies": {
    "webpack": "^5.75.0",
    "webpack-cli": "^5.0.0",
    "webpack-dev-server": "^4.11.0",
    "@babel/core": "^7.20.0",
    "@babel/preset-env": "^7.20.0",
    "babel-loader": "^9.1.0",
    "css-loader": "^6.7.0",
    "style-loader": "^3.3.0",
    "html-webpack-plugin": "^5.5.0"
  },
  "engines": {
    "node": ">=16.0.0"
  },
  "files": [
    "dist/",
    "README.md"
  ]
}

// webpack.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';
  
  return {
    entry: './src/index.js',
    output: {
      path: path.resolve(__dirname, 'dist'),
      filename: isProduction ? '[name].[contenthash].js' : '[name].js',
      clean: true,
      library: {
        name: 'MyPackage',
        type: 'umd'
      }
    },
    module: {
      rules: [
        {
          test: /\.js$/,
          exclude: /node_modules/,
          use: {
            loader: 'babel-loader'
          }
        },
        {
          test: /\.css$/,
          use: ['style-loader', 'css-loader']
        }
      ]
    },
    plugins: [
      new HtmlWebpackPlugin({
        template: './src/index.html'
      })
    ],
    devServer: {
      contentBase: './dist',
      hot: true,
      port: 3000
    },
    optimization: {
      splitChunks: {
        chunks: 'all'
      }
    }
  };
};

// 构建和分发
// npm run build
// npm publish
```
</PythonEditor>

### 构建系统主要差异

| 方面 | Python (setuptools) | JavaScript (webpack) |
|------|-------------------|---------------------|
| **配置** | setup.py/pyproject.toml | webpack.config.js/package.json |
| **依赖** | requirements.txt/setup.py | package.json |
| **构建输出** | wheel/egg 文件 | 打包的 JS/CSS 文件 |
| **开发** | pip install -e . | webpack-dev-server |
| **分发** | PyPI via twine | npm 注册表 |
| **资源处理** | 手动/外部工具 | 内置加载器 |

## Babel 转译

### ES6+ 到兼容 JavaScript

<PythonEditor title="Babel 转译" compare={true}>
```python !! py
# Python 不需要转译
# 版本兼容性通过以下方式处理：
# 1. 语言版本控制（Python 3.8+）
# 2. 特性检测
# 3. 向后移植库

# 示例：使用现代 Python 特性
from __future__ import annotations  # 为旧版 Python

def process_data(items: list[dict]) -> dict[str, int]:
    """使用类型提示处理数据（Python 3.9+ 语法）"""
    return {
        item['name']: item['value'] 
        for item in items 
        if item.get('active', False)
    }

# 为旧版 Python，你可能使用：
from typing import List, Dict

def process_data_compatible(items: List[Dict]) -> Dict[str, int]:
    return {
        item['name']: item['value'] 
        for item in items 
        if item.get('active', False)
    }

# 虚拟环境处理版本隔离
# python -m venv venv
# source venv/bin/activate  # 或 venv\Scripts\activate
```

```javascript !! js
// 现代 JavaScript (ES2020+) - 源代码
// src/modern-features.js

// 可选链和空值合并
const getUserData = (user) => {
    return {
        name: user?.profile?.name ?? 'Anonymous',
        avatar: user?.profile?.avatar ?? '/default-avatar.png',
        posts: user?.posts?.length ?? 0
    };
};

// 带表达式的模板字面量
const createMessage = (user, action) => `
    用户 ${user.name} 执行了 ${action} 
    在 ${new Date().toISOString()}
`;

// 带默认值的解构
const processApiResponse = ({ data = [], status = 'unknown', ...meta }) => {
    return data.map(item => ({
        ...item,
        processed: true,
        timestamp: Date.now()
    }));
};

// 带适当错误处理的 async/await
const fetchUserData = async (userId) => {
    try {
        const response = await fetch(`/api/users/${userId}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return await response.json();
    } catch (error) {
        console.error('获取用户失败:', error);
        throw error;
    }
};

// 带私有字段的类（ES2022）
class UserManager {
    #apiKey;
    
    constructor(apiKey) {
        this.#apiKey = apiKey;
    }
    
    async #makeRequest(endpoint) {
        return fetch(endpoint, {
            headers: {
                'Authorization': `Bearer ${this.#apiKey}`
            }
        });
    }
    
    async getUser(id) {
        const response = await this.#makeRequest(`/users/${id}`);
        return response.json();
    }
}

// Babel 转译后（ES5 兼容）
// dist/compiled.js
"use strict";

function _typeof(obj) {
    "@babel/helpers - typeof";
    return (_typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? 
        function (obj) { return typeof obj; } : 
        function (obj) { return obj && "function" == typeof Symbol && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }
    )(obj);
}

var getUserData = function getUserData(user) {
    var _user$profile, _user$profile2, _user$posts;
    return {
        name: (_user$profile = user === null || user === void 0 ? void 0 : user.profile) === null || _user$profile === void 0 ? void 0 : _user$profile.name,
        avatar: (_user$profile2 = user === null || user === void 0 ? void 0 : user.profile) === null || _user$profile2 === void 0 ? void 0 : _user$profile2.avatar,
        posts: (_user$posts = user === null || user === void 0 ? void 0 : user.posts) === null || _user$posts === void 0 ? void 0 : _user$posts.length
    };
};

// Babel 配置
// .babelrc 或 babel.config.js
module.exports = {
    presets: [
        ['@babel/preset-env', {
            targets: {
                browsers: ['> 1%', 'last 2 versions', 'not ie <= 8']
            },
            useBuiltIns: 'usage',
            corejs: 3
        }]
    ],
    plugins: [
        '@babel/plugin-proposal-class-properties',
        '@babel/plugin-proposal-private-methods',
        '@babel/plugin-proposal-optional-chaining',
        '@babel/plugin-proposal-nullish-coalescing-operator'
    ]
};
```
</PythonEditor>

## 开发服务器和热重载

### 开发环境设置

<PythonEditor title="开发环境" compare={true}>
```python !! py
# Python 开发环境
# 通常由 IDE/编辑器 + 文件监控处理

# 使用 Flask 开发服务器
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return "Hello, World!"

if __name__ == '__main__':
    # 带自动重载的开发服务器
    app.run(debug=True, host='0.0.0.0', port=5000)

# 使用 watchdog 进行文件监控
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
import subprocess
import time

class CodeReloadHandler(FileSystemEventHandler):
    def on_modified(self, event):
        if event.src_path.endswith('.py'):
            print(f"文件 {event.src_path} 已更改，重启中...")
            # 重启应用逻辑
            subprocess.run(['python', 'app.py'])

observer = Observer()
observer.schedule(CodeReloadHandler(), path='.', recursive=True)
observer.start()

# Django 开发服务器
# python manage.py runserver --settings=myproject.settings.dev

# 使用 pytest-watch 进行测试驱动开发
# pip install pytest-watch
# ptw  # 文件更改时自动运行测试
```

```javascript !! js
// JavaScript 使用 webpack-dev-server 开发
// webpack.config.js
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
    mode: 'development',
    entry: './src/index.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: '[name].bundle.js'
    },
    devServer: {
        contentBase: './dist',
        hot: true,                    // 启用热模块替换
        open: true,                   // 自动打开浏览器
        port: 3000,
        historyApiFallback: true,     // 用于 SPA 路由
        compress: true,
        overlay: {                    // 在浏览器中显示错误
            warnings: true,
            errors: true
        },
        watchOptions: {
            aggregateTimeout: 300,
            poll: 1000,
            ignored: /node_modules/
        },
        proxy: {                      // 代理 API 调用
            '/api': {
                target: 'http://localhost:8000',
                changeOrigin: true
            }
        }
    },
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html'
        }),
        new webpack.HotModuleReplacementPlugin()
    ],
    module: {
        rules: [
            {
                test: /\.js$/,
                exclude: /node_modules/,
                use: {
                    loader: 'babel-loader',
                    options: {
                        presets: ['@babel/preset-env']
                    }
                }
            },
            {
                test: /\.css$/,
                use: ['style-loader', 'css-loader']
            }
        ]
    }
};

// 应用代码中的热模块替换
// src/index.js
import { updateUI } from './ui.js';
import './styles.css';

function init() {
    updateUI();
    console.log('应用已初始化');
}

init();

// 接受此模块的热更新
if (module.hot) {
    module.hot.accept('./ui.js', () => {
        console.log('UI 模块已更新');
        updateUI();
    });
    
    module.hot.accept('./styles.css', () => {
        console.log('样式已更新');
    });
}

// 替代方案：使用 Vite 进行更快的开发
// vite.config.js
import { defineConfig } from 'vite';

export default defineConfig({
    server: {
        port: 3000,
        open: true,
        proxy: {
            '/api': 'http://localhost:8000'
        }
    },
    build: {
        outDir: 'dist',
        sourcemap: true
    },
    css: {
        devSourcemap: true
    }
});

// package.json 脚本
{
    "scripts": {
        "dev": "webpack serve --mode=development",
        "dev:vite": "vite",
        "build": "webpack --mode=production",
        "build:vite": "vite build",
        "preview": "vite preview"
    }
}

// 运行开发服务器
// npm run dev
// 自动：
// - 文件更改时编译代码
// - 刷新浏览器
// - 在覆盖层中显示错误
// - 保持应用状态（HMR）
```
</PythonEditor>

## 生产构建和优化

### 构建优化策略

<PythonEditor title="生产优化" compare={true}>
```python !! py
# Python 生产优化
# 通常在部署级别处理

# 使用 gunicorn 作为生产 WSGI 服务器
# gunicorn --workers 4 --bind 0.0.0.0:8000 app:app

# 优化 Python 代码
import functools
import cProfile
import pstats

# 使用 lru_cache 缓存
@functools.lru_cache(maxsize=128)
def expensive_computation(n):
    # 一些昂贵的操作
    return sum(i * i for i in range(n))

# 性能分析优化
def profile_function():
    profiler = cProfile.Profile()
    profiler.enable()
    
    # 你的代码
    result = expensive_computation(1000)
    
    profiler.disable()
    stats = pstats.Stats(profiler)
    stats.sort_stats('cumulative')
    stats.print_stats()

# Docker 生产构建
# Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
RUN python -m compileall .

CMD ["gunicorn", "--workers", "4", "--bind", "0.0.0.0:8000", "app:app"]

# 环境特定设置
import os

class Config:
    DEBUG = False
    SECRET_KEY = os.environ.get('SECRET_KEY')

class DevelopmentConfig(Config):
    DEBUG = True

class ProductionConfig(Config):
    # 生产优化
    pass
```

```javascript !! js
// JavaScript 生产构建优化
// webpack.config.prod.js
const path = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const TerserPlugin = require('terser-webpack-plugin');
const CssMinimizerPlugin = require('css-minimizer-webpack-plugin');
const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');

module.exports = {
    mode: 'production',
    entry: './src/index.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: '[name].[contenthash].js',
        chunkFilename: '[name].[contenthash].chunk.js',
        clean: true,
        publicPath: '/static/'
    },
    optimization: {
        minimize: true,
        minimizer: [
            new TerserPlugin({
                terserOptions: {
                    compress: {
                        drop_console: true,    // 移除 console.log
                        drop_debugger: true    // 移除 debugger 语句
                    }
                }
            }),
            new CssMinimizerPlugin()
        ],
        splitChunks: {
            chunks: 'all',
            cacheGroups: {
                vendor: {
                    test: /[\\/]node_modules[\\/]/,
                    name: 'vendors',
                    chunks: 'all'
                },
                common: {
                    name: 'common',
                    minChunks: 2,
                    chunks: 'all',
                    enforce: true
                }
            }
        },
        runtimeChunk: 'single'
    },
    module: {
        rules: [
            {
                test: /\.js$/,
                exclude: /node_modules/,
                use: {
                    loader: 'babel-loader',
                    options: {
                        presets: [
                            ['@babel/preset-env', {
                                targets: '> 0.25%, not dead',
                                useBuiltIns: 'usage',
                                corejs: 3
                            }]
                        ]
                    }
                }
            },
            {
                test: /\.css$/,
                use: [
                    MiniCssExtractPlugin.loader,
                    'css-loader',
                    'postcss-loader'  // 用于 autoprefixer
                ]
            },
            {
                test: /\.(png|svg|jpg|jpeg|gif)$/i,
                type: 'asset/resource',
                generator: {
                    filename: 'images/[hash][ext][query]'
                }
            }
        ]
    },
    plugins: [
        new MiniCssExtractPlugin({
            filename: '[name].[contenthash].css'
        }),
        new BundleAnalyzerPlugin({
            analyzerMode: process.env.ANALYZE ? 'server' : 'disabled'
        })
    ],
    performance: {
        hints: 'warning',
        maxEntrypointSize: 250000,
        maxAssetSize: 250000
    }
};

// 高级优化技术
// Tree shaking（生产环境自动启用）
// 只导入使用的函数
import { debounce } from 'lodash';  // ❌ 导入整个 lodash
import debounce from 'lodash/debounce';  // ✅ 只导入 debounce

// 使用动态导入进行代码分割
const LazyComponent = React.lazy(() => import('./LazyComponent'));

// 基于路由的代码分割
const routes = [
    {
        path: '/dashboard',
        component: () => import('./Dashboard')
    },
    {
        path: '/profile',
        component: () => import('./Profile')
    }
];

// Service Worker 缓存
// sw.js
const CACHE_NAME = 'my-app-v1';
const urlsToCache = [
    '/',
    '/static/css/main.css',
    '/static/js/main.js'
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => cache.addAll(urlsToCache))
    );
});

// package.json 中的构建脚本
{
    "scripts": {
        "build": "webpack --config webpack.config.prod.js",
        "build:analyze": "ANALYZE=true npm run build",
        "build:stats": "webpack --config webpack.config.prod.js --json > stats.json",
        "serve:prod": "serve -s dist -l 3000"
    }
}

// 环境变量
// .env.production
NODE_ENV=production
API_URL=https://api.myapp.com
CDN_URL=https://cdn.myapp.com

// webpack.DefinePlugin 使用
plugins: [
    new webpack.DefinePlugin({
        'process.env.NODE_ENV': JSON.stringify('production'),
        'process.env.API_URL': JSON.stringify(process.env.API_URL)
    })
]
```
</PythonEditor>

## 现代构建工具

### Vite vs Webpack 对比

<PythonEditor title="现代构建工具" compare={true}>
```python !! py
# Python：Poetry 作为现代依赖管理
# pyproject.toml
[tool.poetry]
name = "my-python-app"
version = "0.1.0"
description = "现代 Python 应用"
authors = ["你的名字 <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.8"
fastapi = "^0.68.0"
uvicorn = "^0.15.0"
pydantic = "^1.8.0"

[tool.poetry.dev-dependencies]
pytest = "^6.2.0"
black = "^21.9b0"
flake8 = "^3.9.0"
mypy = "^0.910"

[tool.poetry.scripts]
my-app = "my_app.main:app"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

# 命令
# poetry install
# poetry add requests
# poetry add --dev pytest
# poetry build
# poetry publish

# 现代 Python 工具
# pyproject.toml 配置所有工具
[tool.black]
line-length = 88
target-version = ['py38']

[tool.mypy]
python_version = "3.8"
warn_return_any = true
strict_optional = true

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
```

```javascript !! js
// Vite：现代快速构建工具
// vite.config.js
import { defineConfig } from 'vite';
import { resolve } from 'path';

export default defineConfig({
    // 使用原生 ES 模块的快速开发
    server: {
        port: 3000,
        hot: true,
        open: true
    },
    
    // 构建配置
    build: {
        outDir: 'dist',
        sourcemap: true,
        rollupOptions: {
            input: {
                main: resolve(__dirname, 'index.html'),
                admin: resolve(__dirname, 'admin.html')
            }
        }
    },
    
    // 插件
    plugins: [
        // 自动安装缺失依赖
        {
            name: 'auto-install',
            configResolved(config) {
                // 插件逻辑
            }
        }
    ],
    
    // CSS 预处理
    css: {
        preprocessorOptions: {
            scss: {
                additionalData: `@import "@/styles/variables.scss";`
            }
        }
    },
    
    // 环境变量
    define: {
        __APP_VERSION__: JSON.stringify(process.env.npm_package_version)
    },
    
    // 路径别名
    resolve: {
        alias: {
            '@': resolve(__dirname, 'src'),
            '@components': resolve(__dirname, 'src/components')
        }
    }
});

// 使用现代工具的 package.json
{
    "name": "modern-js-app",
    "type": "module",  // 使用 ES 模块
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "preview": "vite preview",
        "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
        "format": "prettier --write .",
        "test": "vitest",
        "test:ui": "vitest --ui"
    },
    "devDependencies": {
        "vite": "^4.0.0",
        "vitest": "^0.25.0",
        "@vitejs/plugin-react": "^3.0.0",
        "eslint": "^8.30.0",
        "prettier": "^2.8.0",
        "typescript": "^4.9.0"
    }
}

// 对比：Vite vs Webpack
// Vite 优势：
// ✅ 更快的冷启动（开发时无需打包）
// ✅ 更快的 HMR（热模块替换）
// ✅ 原生 ES 模块支持
// ✅ 内置 TypeScript 支持
// ✅ 更简单的配置

// Webpack 优势：
// ✅ 更成熟的生态系统
// ✅ 更适合复杂配置
// ✅ 更多插件可用
// ✅ 更好的浏览器兼容性

// 现代工具生态系统
// ESLint 配置
// .eslintrc.js
module.exports = {
    extends: [
        'eslint:recommended',
        '@typescript-eslint/recommended',
        'prettier'
    ],
    plugins: ['@typescript-eslint'],
    rules: {
        'no-console': 'warn',
        'prefer-const': 'error',
        '@typescript-eslint/no-unused-vars': 'error'
    }
};

// Prettier 配置
// .prettierrc
{
    "singleQuote": true,
    "trailingComma": "es5",
    "tabWidth": 2,
    "semi": true,
    "printWidth": 80
}

// TypeScript 配置
// tsconfig.json
{
    "compilerOptions": {
        "target": "ESNext",
        "module": "ESNext",
        "moduleResolution": "node",
        "strict": true,
        "jsx": "preserve",
        "esModuleInterop": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "baseUrl": ".",
        "paths": {
            "@/*": ["src/*"],
            "@components/*": ["src/components/*"]
        }
    },
    "include": ["src/**/*"],
    "exclude": ["node_modules", "dist"]
}
```
</PythonEditor>

## CI/CD 流水线设置

### 持续集成和部署

<PythonEditor title="CI/CD 流水线" compare={true}>
```python !! py
# Python 使用 GitHub Actions 的 CI/CD
# .github/workflows/python-app.yml
name: Python application

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, "3.10"]

    steps:
    - uses: actions/checkout@v3
    
    - name: 设置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: 缓存 pip 依赖
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: 使用 flake8 检查代码
      run: |
        flake8 src/ tests/
    
    - name: 使用 black 格式化
      run: |
        black --check src/ tests/
    
    - name: 使用 mypy 类型检查
      run: |
        mypy src/
    
    - name: 使用 pytest 测试
      run: |
        pytest --cov=src --cov-report=xml
    
    - name: 上传覆盖率到 Codecov
      uses: codecov/codecov-action@v3

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 部署到生产环境
      run: |
        # 部署命令
        echo "部署到生产环境"

# Docker 部署
# Dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000

CMD ["gunicorn", "--bind", "0.0.0.0:8000", "app:app"]

# docker-compose.yml
version: '3.8'
services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/myapp
    depends_on:
      - db
  
  db:
    image: postgres:13
    environment:
      POSTGRES_DB: myapp
      POSTGRES_USER: user
      POSTGRES_PASSWORD: pass
```

```javascript !! js
// JavaScript 使用 GitHub Actions 的 CI/CD
// .github/workflows/node.yml
name: Node.js CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - uses: actions/checkout@v3
    
    - name: 使用 Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: 安装依赖
      run: npm ci
    
    - name: 代码检查
      run: npm run lint
    
    - name: 格式检查
      run: npm run format:check
    
    - name: 类型检查
      run: npm run type-check
    
    - name: 运行测试
      run: npm run test:coverage
    
    - name: 构建应用
      run: npm run build
    
    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v3
      with:
        name: build-${{ matrix.node-version }}
        path: dist/

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: 设置 Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: 安装依赖
      run: npm ci
    
    - name: 生产构建
      run: npm run build
      env:
        NODE_ENV: production
        API_URL: ${{ secrets.API_URL }}
    
    - name: 部署到 AWS S3
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      run: |
        aws s3 sync dist/ s3://my-app-bucket --delete
    
    - name: 使 CloudFront 失效
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_ID }} --paths "/*"

# 多阶段 Docker 构建
# Dockerfile
FROM node:18-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

# 开发用 docker-compose.yml
version: '3.8'
services:
  frontend:
    build:
      context: .
      target: development
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
    
  backend:
    image: my-backend:latest
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/myapp

# package.json 中的 CI/CD 脚本
{
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "preview": "vite preview",
        "test": "vitest run",
        "test:watch": "vitest",
        "test:coverage": "vitest run --coverage",
        "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
        "lint:fix": "eslint . --ext .js,.jsx,.ts,.tsx --fix",
        "format": "prettier --write .",
        "format:check": "prettier --check .",
        "type-check": "tsc --noEmit",
        "pre-commit": "lint-staged",
        "prepare": "husky install"
    },
    "lint-staged": {
        "*.{js,jsx,ts,tsx}": ["eslint --fix", "prettier --write"],
        "*.{css,scss,md}": ["prettier --write"]
    }
}

// Netlify 部署配置
// netlify.toml
[build]
  publish = "dist"
  command = "npm run build"

[build.environment]
  NODE_VERSION = "18"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

// Vercel 部署配置
// vercel.json
{
    "builds": [
        {
            "src": "package.json",
            "use": "@vercel/static-build",
            "config": {
                "distDir": "dist"
            }
        }
    ],
    "routes": [
        {
            "src": "/(.*)",
            "dest": "/index.html"
        }
    ]
}
```
</PythonEditor>

## 性能监控和优化

### 构建性能分析

<PythonEditor title="性能监控" compare={true}>
```python !! py
# Python 性能监控
import cProfile
import pstats
import time
import functools
from memory_profiler import profile

# 代码分析
def profile_performance():
    profiler = cProfile.Profile()
    profiler.enable()
    
    # 你的应用代码
    expensive_operation()
    
    profiler.disable()
    stats = pstats.Stats(profiler)
    stats.sort_stats('cumulative')
    stats.print_stats(10)  # 前 10 个最慢的函数

# 内存分析
@profile
def memory_intensive_function():
    # 这将显示逐行内存使用情况
    data = [i**2 for i in range(1000000)]
    return sum(data)

# 性能装饰器
def timing_decorator(func):
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"{func.__name__} 用时 {end - start:.4f} 秒")
        return result
    return wrapper

@timing_decorator
def slow_function():
    time.sleep(1)
    return "完成"

# 使用 APM 工具进行应用监控
# pip install elastic-apm
from elasticapm.contrib.flask import ElasticAPM

app = Flask(__name__)
app.config['ELASTIC_APM'] = {
    'SERVICE_NAME': 'my-python-app',
    'SECRET_TOKEN': 'your-secret-token',
    'SERVER_URL': 'https://your-apm-server.com'
}
apm = ElasticAPM(app)
```

```javascript !! js
// JavaScript 构建性能分析
// webpack-bundle-analyzer
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin;

module.exports = {
    plugins: [
        new BundleAnalyzerPlugin({
            analyzerMode: 'static',
            openAnalyzer: false,
            reportFilename: 'bundle-report.html'
        })
    ]
};

// 速度测量插件
const SpeedMeasurePlugin = require('speed-measure-webpack-plugin');
const smp = new SpeedMeasurePlugin();

module.exports = smp.wrap({
    // 你的 webpack 配置
    plugins: [
        // 你的插件
    ]
});

// 包大小监控
// package.json
{
    "scripts": {
        "analyze": "npm run build && npx webpack-bundle-analyzer dist/stats.json",
        "size": "npm run build && size-limit",
        "build:stats": "webpack --json > dist/stats.json"
    },
    "size-limit": [
        {
            "path": "dist/main.*.js",
            "limit": "250 KB"
        },
        {
            "path": "dist/vendor.*.js",
            "limit": "500 KB"
        }
    ]
}

// 运行时性能监控
// Web Vitals 监控
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

function sendToAnalytics(metric) {
    // 发送到你的分析服务
    console.log(metric);
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);

// Performance API 使用
function measurePerformance() {
    // 标记操作开始
    performance.mark('operation-start');
    
    // 做一些工作
    heavyOperation();
    
    // 标记结束
    performance.mark('operation-end');
    
    // 测量持续时间
    performance.measure('operation-duration', 'operation-start', 'operation-end');
    
    // 获取测量结果
    const measure = performance.getEntriesByName('operation-duration')[0];
    console.log(`操作用时 ${measure.duration}ms`);
}

// Lighthouse CI 集成
// .lighthouserc.js
module.exports = {
    ci: {
        collect: {
            url: ['http://localhost:3000'],
            startServerCommand: 'npm start',
            numberOfRuns: 3
        },
        assert: {
            assertions: {
                'categories:performance': ['error', { minScore: 0.9 }],
                'categories:accessibility': ['error', { minScore: 0.9 }],
                'categories:best-practices': ['error', { minScore: 0.9 }],
                'categories:seo': ['error', { minScore: 0.9 }]
            }
        },
        upload: {
            target: 'temporary-public-storage'
        }
    }
};

// 构建缓存优化
// webpack.config.js
module.exports = {
    cache: {
        type: 'filesystem',
        cacheDirectory: path.resolve(__dirname, '.webpack-cache')
    },
    optimization: {
        moduleIds: 'deterministic',
        runtimeChunk: 'single',
        splitChunks: {
            cacheGroups: {
                vendor: {
                    test: /[\\/]node_modules[\\/]/,
                    name: 'vendors',
                    chunks: 'all'
                }
            }
        }
    }
};

// 源映射分析
// webpack.config.js
module.exports = {
    devtool: process.env.NODE_ENV === 'production' 
        ? 'source-map' 
        : 'eval-source-map',
    optimization: {
        usedExports: true,
        sideEffects: false  // 启用 tree shaking
    }
};
```
</PythonEditor>

## 最佳实践总结

### 构建工具最佳实践

1. **使用现代工具**：优先选择 Vite 或现代 webpack 配置而非传统设置
2. **开发优化**：快速重建和热重载以获得良好的开发体验
3. **生产优化**：压缩、代码分割和缓存
4. **监控性能**：使用包分析器和性能指标
5. **自动化一切**：CI/CD 流水线用于测试、构建和部署

### 开发工作流程最佳实践

1. **一致的环境**：使用 Docker 或确切的 Node.js 版本
2. **代码质量**：ESLint、Prettier 和 TypeScript 以确保可维护性
3. **测试集成**：文件更改时运行测试以及在 CI/CD 中
4. **渐进增强**：为现代浏览器构建，为旧版本回退
5. **安全性**：定期依赖更新和漏洞扫描

## 下一步

在下一个模块中，我们将把所有内容结合起来，通过实际项目演示针对 Python 开发者的现实世界 JavaScript 开发场景。

我们将涵盖的关键主题：
- 全栈 Web 应用
- API 集成项目
- 前端组件库
- CLI 工具开发
- 性能优化案例研究

---

*继续学习 [模块 12：实战项目与综合应用 →](/docs/py2js/module-12-projects)*

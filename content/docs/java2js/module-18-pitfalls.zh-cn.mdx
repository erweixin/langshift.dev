---
title: "模块 18：常见陷阱"
description: "避免常见的 JavaScript 错误和反模式"
---

## 模块 18：常见陷阱

本模块介绍 Java 开发者转向 JavaScript 时常犯的错误。

## 学习目标

完成本模块后，你将：
✅ 了解常见的 JavaScript 陷阱
✅ 理解类型强制转换问题
✅ 学习 async/await 错误
✅ 了解 DOM 操作问题
✅ 理解 this 相关问题
✅ 掌握调试策略

## 类型强制转换

<UniversalEditor title="强制转换陷阱">
```javascript !! js
// ❌ 坏的做法：使用 == 而不是 ===
if (value == "0") { }  // 匹配 0, "0", false

// ✅ 好的做法：使用 ===
if (value === "0") { }

// ❌ 坏的做法：忘记 typeof null
typeof null  // "object"（历史遗留 bug）

// ✅ 好的做法：正确检查 null
if (value === null) { }

// ❌ 坏的做法：NaN 比较
if (NaN === NaN) { }  // 永远为 false！

// ✅ 好的做法：使用 isNaN
if (Number.isNaN(value)) { }
```
</UniversalEditor>

## 异步陷阱

<UniversalEditor title="异步错误">
```javascript !! js
// ❌ 坏的做法：没有 await promise
async function getData() {
  const result = fetch("/api/data");  // 返回 promise，不是数据！
  console.log(result);  // Promise {<pending>}
}

// ✅ 好的做法：await promise
async function getData() {
  const result = await fetch("/api/data");
  const data = await result.json();
  console.log(data);
}

// ❌ 坏的做法：忘记 try-catch
async function risky() {
  const data = await fetchData();  // 未处理的 rejection！
}

// ✅ 好的做法：总是处理错误
async function risky() {
  try {
    const data = await fetchData();
    return data;
  } catch (error) {
    console.error(error);
    throw error;
  }
}
```
</UniversalEditor>

## This 上下文

<UniversalEditor title="This 陷阱">
```javascript !! js
// ❌ 坏的做法：在回调中丢失 this
class Component {
  constructor() {
    this.data = null;

    button.addEventListener("click", this.handleClick);
  }

  handleClick() {
    console.log(this.data);  // undefined！
  }
}

// ✅ 好的做法：绑定或使用箭头函数
class Component {
  constructor() {
    this.data = null;

    // 绑定
    this.handleClick = this.handleClick.bind(this);
    button.addEventListener("click", this.handleClick);

    // 或箭头函数
    button.addEventListener("click", () => this.handleClick());
  }
}
```
</UniversalEditor>

## 循环闭包

<UniversalEditor title="循环闭包问题">
```javascript !! js
// ❌ 坏的做法：循环中使用 var 的闭包
for (var i = 0; i < 3; i++) {
  setTimeout(() => console.log(i), 100);
}
// 输出: 3, 3, 3

// ✅ 好的做法：使用 let
for (let i = 0; i < 3; i++) {
  setTimeout(() => console.log(i), 100);
}
// 输出: 0, 1, 2
```
</UniversalEditor>

## 数组方法

<UniversalEditor title="数组方法陷阱">
```javascript !! js
// ❌ 坏的做法：需要中断时使用 forEach
numbers.forEach(num => {
  if (num === 5) break;  // 错误！
});

// ✅ 好的做法：使用 for...of
for (const num of numbers) {
  if (num === 5) break;
}

// ❌ 坏的做法：在 map 中忘记 return
const doubled = numbers.map(n => {
  n * 2;  // 没有 return！
});

// ✅ 好的做法：总是返回
const doubled = numbers.map(n => n * 2);
```
</UniversalEditor>

## 最佳实践总结

<UniversalEditor title="避免这些错误">
```javascript !! js
// 1. 总是使用 === 和 !==
// 2. 使用 let/const，永远不要 var
// 3. 处理异步错误
// 4. 理解 this 绑定
// 5. 使用 for...of 来中断循环
// 6. 在 map/filter/reduce 中返回
// 7. 检查 null/undefined
// 8. 迭代时不要修改
```
</UniversalEditor>

## 总结

### 关键要点

1. **相等性**：使用 ===，不要用 ==
2. **异步**：总是 await 和 catch
3. **This**：绑定或使用箭头函数
4. **循环**：使用 let，不要用 var
5. **数组**：在回调中返回
6. **Null**：显式检查

## 接下来是什么？

下一节：**模块 19：实战项目** - 构建实际应用程序！

---
title: "模块 16：数据库集成"
---

本模块介绍 Go 中的数据库集成，与 Java 的数据库方法进行比较。

## 数据库访问模式

**Java 数据库方法：**
- JDBC：低级数据库访问
- Spring Data JPA：带仓储的 ORM
- Hibernate：功能丰富的 ORM
- MyBatis：SQL 映射框架
- jOOQ：类型安全的 SQL

**Go 数据库方法：**
- database/sql：标准库接口
- GORM：全功能 ORM
- sqlx：database/sql 的扩展
- sqlc：类型安全的 SQL 代码生成

<UniversalEditor title="基本数据库操作">
```java !! java
// Java: Spring Data JPA
@Service
@Transactional
public class UserService {

    @Autowired
    private UserRepository userRepository;

    public User createUser(String email, String name) {
        User user = new User();
        user.setEmail(email);
        user.setName(name);
        return userRepository.save(user);
    }

    public Optional<User> getUserById(Long id) {
        return userRepository.findById(id);
    }

    public Optional<User> getUserByEmail(String email) {
        return userRepository.findByEmail(email);
    }

    public List<User> searchUsers(String keyword) {
        return userRepository.findByNameContainingIgnoreCase(keyword);
    }

    public User updateUser(Long id, String name) {
        User user = userRepository.findById(id)
            .orElseThrow(() -> new UserNotFoundException(id));
        user.setName(name);
        return userRepository.save(user);
    }

    public void deleteUser(Long id) {
        if (!userRepository.existsById(id)) {
            throw new UserNotFoundException(id);
        }
        userRepository.deleteById(id);
    }
}
```

```go !! go
// Go: GORM
package main

import (
    "gorm.io/gorm"
    "gorm.io/gorm/clause"
)

type UserService struct {
    db *gorm.DB
}

func NewUserService(db *gorm.DB) *UserService {
    return &UserService{db: db}
}

func (s *UserService) CreateUser(email, name string) (*User, error) {
    user := &User{
        Email: email,
        Name:  name,
    }

    if err := s.db.Create(user).Error; err != nil {
        return nil, err
    }

    return user, nil
}

func (s *UserService) GetUserByID(id uint) (*User, error) {
    var user User
    err := s.db.First(&user, id).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

func (s *UserService) GetUserByEmail(email string) (*User, error) {
    var user User
    err := s.db.Where("email = ?", email).First(&user).Error
    if err != nil {
        return nil, err
    }
    return &user, nil
}

func (s *UserService) SearchUsers(keyword string) ([]User, error) {
    var users []User
    err := s.db.Where("name ILIKE ?", "%"+keyword+"%").Find(&users).Error
    return users, err
}

func (s *UserService) UpdateUser(id uint, name string) (*User, error) {
    var user User
    if err := s.db.First(&user, id).Error; err != nil {
        return nil, err
    }

    user.Name = name
    if err := s.db.Save(&user).Error; err != nil {
        return nil, err
    }

    return &user, nil
}

func (s *UserService) DeleteUser(id uint) error {
    result := s.db.Delete(&User{}, id)
    if result.Error != nil {
        return result.Error
    }
    if result.RowsAffected == 0 {
        return gorm.ErrRecordNotFound
    }
    return nil
}

// 事务示例
func (s *UserService) TransferFunds(fromID, toID uint, amount float64) error {
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 锁定行以进行更新
        var fromUser User
        if err := tx.Clauses(clause.Locking{Strength: "UPDATE"}).
            First(&fromUser, fromID).Error; err != nil {
            return err
        }

        var toUser User
        if err := tx.Clauses(clause.Locking{Strength: "UPDATE"}).
            First(&toUser, toID).Error; err != nil {
            return err
        }

        fromUser.Balance -= amount
        toUser.Balance += amount

        if err := tx.Save(&fromUser).Error; err != nil {
            return err
        }

        if err := tx.Save(&toUser).Error; err != nil {
            return err
        }

        return nil
    })
}
```
</UniversalEditor>

## 连接池

<UniversalEditor title="连接池配置">
```java !! java
// Java: HikariCP (Spring Boot)
// application.properties
spring.datasource.url=jdbc:postgresql://localhost:5432/mydb
spring.datasource.username=myuser
spring.datasource.password=mypassword
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
```

```go !! go
// Go: database/sql 连接池
package main

import (
    "database/sql"
    "time"
    _ "github.com/lib/pq"
)

func NewDB(dataSourceName string) (*sql.DB, error) {
    db, err := sql.Open("postgres", dataSourceName)
    if err != nil {
        return nil, err
    }

    // 连接池设置
    db.SetMaxOpenConns(25)           // 最大打开连接数
    db.SetMaxIdleConns(5)            // 最大空闲连接数
    db.SetConnMaxLifetime(5 * time.Minute)  // 最大连接生命周期
    db.SetConnMaxIdleTime(1 * time.Minute)  // 连接的最大空闲时间

    // 验证连接
    if err := db.Ping(); err != nil {
        return nil, err
    }

    return db, nil
}
```
</UniversalEditor>

---

### 练习问题：
1. 什么时候应该使用 GORM vs sqlx vs 原始 SQL？
2. Go 的事务方法与 Java 有什么不同？
3. Go 的 database/sql 接口有什么优势？
4. Go 中的连接池与 Java 相比如何工作？

### 项目想法：
- 构建具有完整 CRUD 操作的 REST API
- 为多服务应用实现数据库迁移
- 创建具有复杂查询的报告服务
- 设置读副本和写分离

### 下一步：
- 学习微服务架构
- 探索真实世界项目模式
- 构建生产就绪的应用程序

---
title: "模块 17: 测试"
description: "掌握 Rust 测试,包括单元测试、集成测试、基于属性的测试和模拟策略"
---

# 模块 17: 测试

## 学习目标

完成本模块后,你将能够:
- 使用 `#[test]` 属性编写单元测试
- 在 `tests/` 目录中创建集成测试
- 使用断言和自定义测试输出
- 使用 Tokio 测试异步代码
- 使用 proptest 实现基于属性的测试
- 为隔离测试模拟依赖

## Rust 测试简介

Rust 有内置的测试支持,不像 Python 需要外部框架(虽然 pytest 非常流行)。

<UniversalEditor compare={true} title="基本测试设置">
```python !! py
# Python - pytest 结构
# test_calculator.py
import pytest

def add(a: int, b: int) -> int:
    return a + b

def test_add_positive():
    assert add(2, 3) == 5

def test_add_negative():
    assert add(-1, 1) == 0

@pytest.mark.parametrize("a,b,expected", [
    (1, 2, 3),
    (0, 0, 0),
    (-1, 1, 0),
])
def test_add_various(a, b, expected):
    assert add(a, b) == expected

# 运行: pytest test_calculator.py
```

```rust !! rs
// Rust - 内置测试
// calculator.rs 或 tests/calculator_test.rs

fn add(a: i32, b: i32) -> i32 {
    a + b
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_add_positive() {
        assert_eq!(add(2, 3), 5);
    }

    #[test]
    fn test_add_negative() {
        assert_eq!(add(-1, 1), 0);
    }

    // 没有内置的参数化,但可以迭代
    #[test]
    fn test_add_various() {
        let cases = [(1, 2, 3), (0, 0, 0), (-1, 1, 0)];
        for (a, b, expected) in cases {
            assert_eq!(add(a, b), expected);
        }
    }
}

// 运行: cargo test
```
</UniversalEditor>

## 单元测试 vs 集成测试

Rust 有两种不同位置的测试类型:

<UniversalEditor compare={true} title="测试组织">
```python !! py
# Python - 平坦结构
# src/calculator.py
def add(a, b):
    return a + b

# tests/test_calculator.py
import pytest
from calculator import add

def test_add():
    assert add(2, 3) == 5
```

```rust !! rs
// Rust - 分离的单元和集成测试
// src/lib.rs 或 src/main.rs
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

// 单元测试:在同一文件中
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_add() {
        assert_eq!(add(2, 3), 5);
    }
}

// 集成测试:在 tests/ 目录中
// tests/integration_test.rs
use my_crate::add;

#[test]
fn test_integration_add() {
    assert_eq!(add(10, 20), 30);
}
```
</UniversalEditor>

**关键点:**
- **单元测试**: 测试私有函数,放在同一模块中
- **集成测试**: 测试公共 API,放在 `tests/` 目录中

## 运行测试

<UniversalEditor compare={true} title="测试命令">
```bash !! bash
# Python - pytest 命令
# 运行所有测试
pytest

# 运行特定文件
pytest test_calculator.py

# 详细输出
pytest -v

# 带覆盖率
pytest --cov=src --cov-report=html
```

```rust !! rs
// Rust - cargo test 命令
// 运行所有测试
cargo test

// 运行特定测试
cargo test test_add

// 详细输出(显示打印输出)
cargo test -- --nocapture

// 只运行集成测试
cargo test --test integration_test

// 运行文档测试
cargo test --doc

// 发布模式运行测试(更快)
cargo test --release
```
</UniversalEditor>

## 关键要点

### 测试哲学
- **Python**: 强调简单性和表现力
- **Rust**: 内置测试,注重安全性和性能

### 测试组织
- **Python**: 测试在 `test_*.py` 文件中
- **Rust**: 单元测试在同一文件,集成测试在 `tests/` 目录

### 异步测试
- **Python**: 需要 pytest-asyncio 插件
- **Rust**: 需要 `#[tokio::test]` 宏

## 练习

1. 为计算器的所有基本操作编写单元测试
2. 为 REST API 客户端创建集成测试
3. 为排序算法实现基于属性的测试
4. 为数据库 trait 构建模拟实现
5. 为不同排序算法添加基准测试

## 下一模块

在模块 18 中,我们将探索 **Rust 宏**,包括使用 `macro_rules!` 的声明式宏、派生宏和过程宏。
